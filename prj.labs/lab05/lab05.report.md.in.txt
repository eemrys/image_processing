## Работа 5. Исправление проективных искажений изображений страниц
автор: Яковлева А.А.
url: https://mysvn.ru/yakovleva/yakovleva_a_a/prj.labs/lab05

### Задание
1. Нарисовать эталонную "разметку" (четырехугольник изображения страницы) для отсканированного изображения и фотографий (не менее 5 любых).
2. Изготовить эталонную бинаризацию для скана.
3. Запрограммировать совмещение изображений при помощи гомографии с использованием эталонной геометрической разметки.
4. Используя эталонную геометрическую разметку реализовать численную оценку качества бинаризации (из лабораторной 4) для совмещенных изображений (для отдельных изображений и для набора).
5. Реализовать представление результатов выполнения лабораторной (иллюстрации, таблицы, графики и т.д.) и вставить в отчет.
6. Произвести уточнение параметров бинаризации (улучшение качества для набора изображений) и продемонстрировать результаты после уточнения.

### Описание процесса

Для сшивки изображений использовались функции findHomography и warpPerspective.

Разметка:

|Изображение|Верхний левый угол|Верхний правый угол|Нижний левый угол|Нижний правый угол|
|--------------------|------------------------|--------------|------------|-------------|
|lab05.scan.png|(0, 0)|(2450, 0)|(0, 3490)|(2450, 3490) |
|lab05.photo1.jpg|(380,484) | (2209,511) | (2306,3215) | (305,3232) |
|lab05.photo2.jpg|(400,611) | (2009,609) | (2031,2938) | (379, 2918) |
|lab05.photo3.jpg|(534,1966) | (449,294) | (3175,61) | (3088,2165) |
|lab05.photo4.jpg|(612,1996) | (694,488) | (3020,203) | (3127,2168)|
|lab05.photo5.jpg|(2839,450) | (2786,2169) | (472,2060) | (469,454)|

Для бинаризации использовались методы adaptiveThreshold и GaussianBlur. Порог бинаризации - взвешенная сумма (кросс-корреляция с гауссовым окном) пикселей картинки.

Для оценки качества бинаризации применена F-мера:
- выделены компоненты связности обоих изображений
- для каждой компоненты связности эталонного изображения вычислены координаты наименьшего прямоугольника на изображении, включающего эту компоненту
- для этого прямоугольника вычислено количество совпадающих черных пикселей на эталоне и на оцениваемом изображении
- значение true positive - это отношение количества совпадающих черных пикселей к площади текущей компаненты связности на эталонном изображении
- значение false positive - это количество выявленных на оцениваемом изображении компонент связности, таких, что на эталонном изображении в этом месте нет чёрных пикселей
- значение false negative - это количество выявленных на эталонном изображении компонент связности, таких, что на оцениваемом изображении в этом месте нет чёрных пикселей
- значение recall:
    $$recall=\frac{true positive}{true positive + false negative}$$
- значение precision:
    $$precision=\frac{true positive}{true positive + false positive}$$
- значение F-меры:
    $$F=\frac{2 * precision * recall}{precision + recall}$$


Уточнение параметров (новые значения найдены эмпирическим путем):

|Параметр|До уточнения|После уточнения|
|-------------------------|------|-----|
|adaptiveThreshold: размер блока|19|28|
|adaptiveThreshold: вычитаемая константа|10|6|
|GaussianBlur: размер ядра|3|5|


### Результаты

![](lab05.b1.png)
Рис. 1. Визуализация эталонной разметки 1 фотографии

![](lab05.h1.png)
Рис. 2. Визуализация совмещения 1 фотографии со сканом

![](lab05.b2.png)
Рис. 3. Визуализация эталонной разметки 2 фотографии

![](lab05.h2.png)
Рис. 4. Визуализация совмещения 2 фотографии со сканом

![](lab05.b3.png)
Рис. 5. Визуализация эталонной разметки 3 фотографии

![](lab05.h3.png)
Рис. 6. Визуализация совмещения 3 фотографии со сканом

![](lab05.b4.png)
Рис. 7. Визуализация эталонной разметки 4 фотографии

![](lab05.h4.png)
Рис. 8. Визуализация совмещения 4 фотографии со сканом

![](lab05.b5.png)
Рис. 9. Визуализация эталонной разметки 5 фотографии

![](lab05.h5.png)
Рис. 10. Визуализация совмещения 5 фотографии со сканом

![](lab05.v1.version1.png)
Рис. 11. Визуализация бинаризации 1 фотографии

![](lab05.e1.version1.png)
Рис. 12. Визуализация отклонения бинаризации 1 фотографии от эталона

![](lab05.v2.version1.png)
Рис. 13. Визуализация бинаризации 2 фотографии

![](lab05.e2.version1.png)
Рис. 14. Визуализация отклонения бинаризации 2 фотографии от эталона

![](lab05.v3.version1.png)
Рис. 15. Визуализация бинаризации 3 фотографии

![](lab05.e3.version1.png)
Рис. 16. Визуализация отклонения бинаризации 3 фотографии от эталона

![](lab05.v4.version1.png)
Рис. 17. Визуализация бинаризации 4 фотографии

![](lab05.e4.version1.png)
Рис. 18. Визуализация отклонения бинаризации 4 фотографии от эталона

![](lab05.v5.version1.png)
Рис. 19. Визуализация бинаризации 5 фотографии

![](lab05.e5.version1.png)
Рис. 20. Визуализация отклонения бинаризации 5 фотографии от эталона

![](lab05.v1.version2.png)
Рис. 21. Визуализация бинаризации 1 фотографии

![](lab05.e1.version2.png)
Рис. 22. Визуализация отклонения бинаризации 1 фотографии от эталона

![](lab05.v2.version2.png)
Рис. 23. Визуализация бинаризации 2 фотографии

![](lab05.e2.version2.png)
Рис. 24. Визуализация отклонения бинаризации 2 фотографии от эталона

![](lab05.v3.version2.png)
Рис. 25. Визуализация бинаризации 3 фотографии

![](lab05.e3.version2.png)
Рис. 26. Визуализация отклонения бинаризации 3 фотографии от эталона

![](lab05.v4.version2.png)
Рис. 27. Визуализация бинаризации 4 фотографии

![](lab05.e4.version2.png)
Рис. 28. Визуализация отклонения бинаризации 4 фотографии от эталона

![](lab05.v5.version2.png)
Рис. 29. Визуализация бинаризации 5 фотографии

![](lab05.e5.version2.png)
Рис. 30. Визуализация отклонения бинаризации 5 фотографии от эталона


Сравнение F-меры до и после уточнения параметров: 

|Изображение|Оценка до уточнения|Оценка после уточнения|
|--------------------|------|----|
|lab05.photo1.jpg|0.812|0.831|
|lab05.photo2.jpg|0.728|0.751|
|lab05.photo3.jpg|0.784|0.796|
|lab05.photo4.jpg|0.721|0.741|
|lab05.photo5.jpg|0.701|0.728|
|Среднее|0.749|0.769|


### Текст программы

```cpp
@cpp_source@
```
